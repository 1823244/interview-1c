

# Параметры виртуальных таблиц

На ИТС есть статья  "Использование параметров - периодов в системе компоновки данных"
    https://its.1c.ru/db/metod8dev/content/1555/hdoc

или в целом рекомендации по СКД  
    https://its.1c.ru/db/metod8dev#browse:13:-1:3199:3224:3226:3231


Но сначала немного опыта.  

## ВТ Остатков

### Использование Границы

В СКД параметр ВТ остатков работает таким образом, что получает остатки **ИСКЛЮЧИТЕЛЬНО**, т.е. на начало секунды.  

К счастью, в типовых есть общий модуль КомпоновкаДанныхСервер с некоторыми полезными функциями, например:  

```bsl
Функция ГраницаПериода(Дата, ВидГраницыИмяЗначения) Экспорт
	Возврат Новый Граница(Дата, ВидГраницы[ВидГраницыИмяЗначения]);
КонецФункции
```

В колонку Выражение параметра с периодом ВТ Остатков впишем:  
    КомпоновкаДанныхСервер.ГраницаПериода(&Период.ДатаОкончания, "Включая"), если Период - это СтандартныйПериод
    или 
    КомпоновкаДанныхСервер.ГраницаПериода(&Период, "Включая"), если Период - дата

### Теперь про указание параметрв в ВТ.  

Чтобы работала возможность использовать Граница, так параметр указывать нельзя:  

```
выбрать 
	* 
из
	регистрНакопления.товарынаскладах.Остатки
	(
		&ПериодОстатков
	)

```

Правильный способ:  

```
выбрать 
	* 
из
	регистрНакопления.товарынаскладах.Остатки
	(
		{(&ПериодОстатков)}
	)

```

Подробнее.  

1. Мы использовали &ПериодОстатков в запросе.  
2. На странице Параметры мы создаем еще один параметр, например &Период с типом Дата и этот параметр добавляем в пользовательски.  
3. У параметра &ПериодОстатков включаем "Ограничение доступности".  
4. В выражение параметра &ПериодОстатков пишем текст:  
    КомпоновкаДанныхСервер.ГраницаПериода(&Период, "Включая")
5. Создавать параметр &Период обязательно, потому что нельзя написать Выражение на самого себя - в нашем случае на параметр &ПериодОстатков, будет ошибка "Несоответствие типов (Параметр номер 1)".

СКД под капотом создает параметр &П, который подставляет в финальный текст запроса.  
Это можно увидеть через консоль СКД, файл 01_СтендСКД_Асинхронный.erf, в этом же каталоге.  
ID публикации на infostart.ru - 179939  

Вот такой будет запрос:  

```
ВЫБРАТЬ
	товарынаскладахОстатки.Номенклатура КАК Номенклатура,
	товарынаскладахОстатки.Склад КАК Склад,
	товарынаскладахОстатки.ВНаличииОстаток КАК ВНаличииОстаток,
	товарынаскладахОстатки.КОтгрузкеОстаток КАК КОтгрузкеОстаток,
	ПРЕДСТАВЛЕНИЕССЫЛКИ(товарынаскладахОстатки.Номенклатура) КАК НоменклатураПредставление,
	ПРЕДСТАВЛЕНИЕССЫЛКИ(товарынаскладахОстатки.Склад) КАК СкладПредставление
ИЗ
	РегистрНакопления.ТоварыНаСкладах.Остатки(&П, ) КАК товарынаскладахОстатки
```

При НЕправильном указании параметра, параметр &П будет содержать дату из параметра &Период.  
Это можно увидеть в приложенной консоли на странице "Макет СКД", там еще есть блок страниц,  нужная нам - "Параметры макета".  

При правильном - параметр &П будет содержать Выражение параметра &ПериодОстатков, а именно:  
    КомпоновкаДанныхСервер.ГраницаПериода(&Период, "Включая")

-----------

Вообще в СКД не очень удобно создавать параметр типа Дата, потому что пользователю придется указывать секунды для дата остатков (или окончания для оборотов):
    23:59:59  

Но если приходится - можно в Выражении сразу написать КонецПериода():  
    
    КомпоновкаДанныхСервер.ГраницаПериода( КонецПериода(&Период,"ДЕНЬ"), "Включая")  

И кстати, в списке выбора стандартных дат СКД будут только даты типа Начало...:  
    * Начало этого дня  
    * Начало этой недели  

т.е. не будет дат типа Конец..., поэтому надо использовать КонецПериода().  

Тогда можно для пользовательского параметра использовать типа Дата без времени.  



