# Блокировки

## ИТС
Статья от 2007 года.  
https://its.1c.ru/db/metod8dev/content/5839/hdoc  

Система стандартов  
https://its.1c.ru/db/v8std/content/490/hdoc  

Просмотр блокировок в кластере  
https://its.1c.ru/db/v8320doc#bookmark:cs:TI000000179  


# Виды блокировок 1С
Объектные и транзакционные блокировки  

## Объектные

Механизм объектных блокировок позволяет осуществлять конкурентный доступ пользователей к данным 1С:Предприятия в терминах объектов информационной базы. Как правило, в большинстве случаев это связано с интерактивной работой пользователей в формах: редактирование существующих объектов, удаление, создание новых и др. (https://its.1c.ru/db/metod8dev/content/5839/hdoc)   

Виды: Пессимистические и оптимистические

https://gendalf.ru/news/all/tipy-blokirovok-dannykh-_1s_-i-subd_-kak-oni-rabotayut/  

    * Оптимистические. Построены на анализе номера версии объекта, хранящейся в базе данных и номера версии, помещенной в память компьютера в момент считывания данных из информационной базы. Если при записи объекта номера его версий отличаются, то будет выдано предупреждение о том, что версия объекта изменилась или он был удален, то есть сработает оптимистическая блокировка.
    
    * Пессимистические. В тот момент, когда пользователь начинает модификацию объекта в форме, расширение формы устанавливает пессимистическую блокировку. Если после этого другой пользователь, например, попытается выполнить редактирование того же объекта, ему будет выдано сообщение о невозможности блокировки объекта. Когда пользователь, редактировавший объект, закроет форму объекта, расширение формы снимет пессимистическую блокировку.

## Объектная пессимистическая блокировка

Пессимистическая блокировка объектов базы данных предназначена для того, чтобы запретить изменение данных определенного объекта другими сеансами или данным сеансом до тех пор, пока блокировка не будет снята этим объектом встроенного языка.  

Используется для блокировки объектов, редактируемых в форме. В тот момент, когда пользователь начинает модификацию объекта в форме, расширение формы устанавливает пессимистическую блокировку. Если после этого другой пользователь, например, попытается выполнить редактирование того же объекта, ему будет выдано сообщение о том, что не удалось заблокировать объект. Когда пользователь, редактировавший объект, закроет форму объекта, расширение формы снимет пессимистическую блокировку.  

Рассмотрим пример. Войдем в прилагаемую к работе информационную базу под пользователем Иванов, откроем форму элемента справочника Номенклатура (код 12) и изменим цену продажи с 420,00 на 450,00. Не сохраняя сделанные изменения, войдем в информационную базу еще раз, но теперь под именем пользователя Петров. Откроем форму того же элемента справочника и попробуем изменить значение какого-либо реквизита. Любая попытка изменения приведет к появлению специального окна с сообщением об ошибке (рис. 9)

```"Не удалось заблокировать запись. Действие (изменение, удаление или блокировка) не выполнено. Запись заблокирована пользователем Иванов с комеьютера XXX из приложения 1С Предприяитие, соединение 1```

Таким образом пессимистическая блокировка гарантирует, что пользователь, начав изменять данные объекта, сможет записать эти изменения в информационную базу.  

В то же время, разработчик имеет возможность задействовать рассматриваемый механизм, используя средства встроенного языка. Для того, чтобы установить пессимистическую блокировку объекта, можно использовать метод объекта Заблокировать().  

ВНИМАНИЕ  

Сам по себе факт установки блокировки не препятствует изменению или удалению объекта в базе данных. Поэтому для того, чтобы обеспечить невозможность изменения заблокированного объекта, операции изменения объекта в другом сеансе должна также предшествовать попытка блокировки того же самого объекта. Блокировка заблокированного объекта базы данных вызывает исключение, которое может быть обработано конструкцией Попытка ... Исключение ... КонецПопытки.  

Для снятия пессимистической блокировки разработчик может использовать метод объекта Разблокировать(), причем использовать его для того же самого экземпляра объекта, для которого ранее была установлена блокировка.  

Рассматривая возможность взаимного влияния механизмов объектных и транзакционных блокировок, напомним, что объектные блокировки не влияют на операции над данными и на процесс течения транзакций. Если блокировка объекта вызвала исключение, то оно, как было указано выше, может быть обработано разработчиком конфигурации и не приведет к обязательному откату транзакции. С другой стороны, блокировки объектов, установленные в течение транзакции, сохраняются при фиксации транзакции и снимаются при откате транзакции.  


Статья https://infostart.ru/public/543218.  

Для того, чтобы обеспечить невозможность изменения или удаления заблокированного объект необходимо произвести проверку на блокировку объекта.

Есть два способа проверки:

    Метод «Заблокирован()» используется для проверки блокировки объекта базы данных текущим сеансом. Данный метод не предоставляет возможность проверки заблокирован ли объект вообще.
    Для проверки заблокирован объект базы данных вообще используется метод «Заблокировать()». Попытка блокировки заблокированного объекта вызывает исключение, которое может быть обработано конструкцией «Попытка…..Исключение…..КонецПопытки».

### Пессимистическая блокировка в управляемых формах

При работе с управляемыми формами методы «Заблокировать()», «Разблокировать()» и «Заблокирован()» могут не подойти из-за специфики работы управляемого приложения.

Дело в том, что данные методы используются для объектов базы данных. Объект базы данных существует только на сервере. Получается, разработчику придется выполнить серверный вызов, получить объект базы данных путем преобразования основного реквизита формы с помощью метода формы «РеквизитФормыВЗначение». Далее вызывается один из методов объекта «Заблокировать()», «Разблокировать()» или «Заблокирован()». Но данный способ блокировки будет бесполезен, если задача стоит, чтобы объект был заблокирован пока открыта форма, так как полученный объект будет жить до конца серверного вызова.

Для работы с блокировками из управляемой формы необходимо использовать методы:  
```ЗаблокироватьДанныеФормыДляРедактирования()```  
    (метод формы)  
    Описание:  
    Устанавливает блокировку сохраняемых данных формы в информационной базе для редактирования.  
    Доступность:  
    Тонкий клиент, веб-клиент, сервер, толстый клиент, мобильное приложение (сервер), мобильный автономный сервер.  
    Вызов метода выполняет обращение к серверу.  
и  
```РазблокироватьДанныеФормыДляРедактирования()```.  
    (метод формы)  

Данные методы используются для блокировки или разблокировки данных основного реквизита формы.  

ЕНС. Есть еще методы:  
```ЗаблокироватьДанныеДляРедактирования()```  
    (глобальный метод)  
    Описание:   
    Заблокировать данные для редактирования в форме клиентского приложения.
    Вызывает исключение, если объект уже заблокирован, в том числе и методом Заблокировать.  
    Доступность:  
    Сервер, толстый клиент, внешнее соединение, мобильное приложение (сервер), мобильный автономный сервер.  
и  
```РазблокироватьДанныеДляРедактирования()```  
(глобальный метод)  

ЕНС. Отличия этих методов.  
(https://forum.mista.ru/topic.php?id=875822)  
 
    ЗаблокироватьДанныеДляРедактирования() с указанием идентификатора формы ‑ в этом случае блокировка устанавливается на время жизни формы. При закрытии формы блокировка будет снята сразу, если используется обычное соединение или по прошествии некоторого времени, если используется медленное соединение. Во всех следующих случаях блокировка будет снята сразу:

    ● Завершен сеанс, в котором открыта форма.

    ● Прошла 1 минута после сброса признака модифицированности формы.

    ● За время отображения формы были установлены другие блокировки от имени этой формы (при интерактивном редактировании или методом ЗаблокироватьДанныеФормыДляРедактирования()).

    ● Закрывается форма, от имени которой были запущены и не завершены фоновые задания (поиск в динамическом списке или формирование отчета).

    ● Использован метод глобального контекста РазблокироватьДанныеДляРедактирования() с указанием того же идентификатора формы, который указывался для установки блокировки.


Рассмотрим пример. В разделе «Нормативно-справочная информация» откроем любой элемент справочника «Номенклатура» под пользователем «Васильев В.В.», внесем изменения в наименование и не сохраняя под пользователем «Иванов И.И.» отроем тот же элемент справочника. При попытки внесения изменений система выдаст сообщение об ошибке.


Далее в форме элемента справочника под пользователем «Васильев В.В.» нажмем на кнопку «Разблокировать» (рис. 1.7) и попробуем снова внести изменения в данный элемент справочника под пользователем «Иванов И.И.». В данном случае система даст внести изменения и записать элемент справочника.


Для отключения пессимистической блокировки в управляемых формах в свойстве основного реквизита надо снять флаг «Сохраняемые данные». Данный флаг определяет будут ли при интерактивном редактировании блокироваться данные основного реквизита, или нет 
    
Конец https://infostart.ru/public/543218.  

## Объектная оптимистическая блокировка

Оптимистическая блокировка запрещает запись объекта в базу данных, если после считывания объекта он был изменен в базе данных другими сеансами или другими программными объектами этого же сеанса.  

Фактически, оптимистическая блокировка представляет собой проверку, которая выполняется перед записью объекта в базу данных. Эта проверка построена на анализе номера версии объекта, хранящейся в базе данных и номера версии, помещенной в память компьютера в момент считывания данных из информационной базы. Если при записи объекта номера его версий отличаются, то будет выдано предупреждение о том, что версия объекта изменилась или он был удален, то есть сработает оптимистическая блокировка.  

Рассмотрим пример. Откроем два сеанса работы с прилагаемой к работе информационной базой: один под пользователем Иванов, а другой - под пользователем Петров. В обоих сеансах откроем откроем форму элемента Управление торговлей справочника Номенклатура (код 12). Теперь в сеансе, открытом от имени пользователя Иванов, изменим цену продажи с 420,00 на 450,00 и запишем сделанные изменения. После этого, в сеансе, открытом от имени пользователя Петров попробуем изменить значение какого-либо реквизита. Любая попытка изменения приведет к появлению другого окна с сообщением об ошибке (рис. 10):

```"Операция не может быть выполнена из-за несоответствия версии или отсутствия записи базы данных (возможно запись была изменена или удалена)!"```

Таким образом оптимистическая блокировка гарантирует, что пользователь изменяет актуальные данные объекта, которые хранятся в информационной базе, а не какой-то их предыдущий вариант. 

## Транзакционные

Для согласованного изменения данных в СУБД используется механизм транзакций, а для обеспечения конкурентного доступа к данным - механизм транзакционных блокировок. (https://its.1c.ru/db/metod8dev/content/5839/hdoc)  

Виды: автоматическая и управляемая.  

## Режим автоматических блокировок

Режим автоматических блокировок в 1С:Предприятии 8.1 полностью аналогичен механизму транзакционных блокировок, использовавшемуся в версии 8.0. В этом режиме 1С:Предприятие целиком «полагается» на возможности, предоставляемые СУБД.  

Такой подход позволяет разработчику не задумываться о достаточно сложных вопросах блокирования нужных данных в транзакции. Однако СУБД не имеет информации о логической структуре данных 1С:Предприятия, и платформе приходится использовать достаточно высокие уровни изоляции транзакций СУБД для того, чтобы обеспечить целостность и непротиворечивость данных (табл. 3): Repeatable Read и Serializable для MS SQL Server, Serializable для IBM DB2 и блокировка таблиц целиком для PostgreSQL. 

Таблица 3. Блокировки СУБД, используемые в режиме автоматических блокировок в транзакции
  	

СУБД
  	

 Файловая база данных
	

 MS SQL Server
	

 IBM DB2
	

 PostgreSQL
 Вид блокировок 	

 Таблиц
	

 Записей
	

 Записей
	

 Таблиц
 Уровень изоляции транзакций 	

 Serializable
	

 Repeatable Read или Serializable
	

 Serializable
	

 Read Committed

Зачастую такой подход приводит к возникновению «плохих» (избыточных) блокировок и не позволяет достичь желаемой параллельности работы пользователей. В клиент-серверном варианте блокировка данных происходит на уровне записей, однако может быть заблокирована и вся таблица целиком (например, в результате выбора СУБД неоптимального плана выполнения запроса ). Тип блокировок, устанавливаемых в том или ином случае, зависит от вида операции, используемого 1С:Предприятием уровня изоляции транзакций и определяется внутренними механизмами самой СУБД (например, MS SQL Server).

## Режим управляемых блокировок

В 1С:Предприятии версии 8.1 реализован дополнительный режим работы, позволяющий использовать собственный менеджер транзакционных блокировок 1С:Предприятия, независимый от используемой СУБД (рис. 16). 

Рис. 3.16. Управляемые блокировки в транзакции 1С:Предприятия 8.1

Рис. 16. Управляемые блокировки в транзакции 1С:Предприятия 8.1

При работе в этом режиме система использует гораздо более низкий уровень изоляции транзакций для MS SQL Server и IBM DB2, и блокировку на уровне записей для PostgreSQL (см. таблицу 3). Это позволяет достичь более высокой параллельности работы пользователей.

Таблица 3. Блокировки СУБД, используемые в режиме управляемых блокировок в транзакции
  	

СУБД
  	

 Файловая база данных
	

 MS SQL Server
	

 IBM DB2
	

 PostgreSQL
 Вид блокировок 	

 Таблиц
	

 Записей
	

 Записей
	

 Записей
 Уровень изоляции транзакций 	

 Serializable
	

 Read Committed
	

 Read Committed
	

 Read Committed

Однако этот уровень изоляции транзакций СУБД уже не может сам по себе обеспечить целостность и непротиворечивость данных во всех случаях. Поэтому 1С:Предприятие 8.1 при модификации данных методами встроенного языка (например, метод Записать() у объектных данных) устанавливает собственные управляемые блокировки в транзакции, которые обрабатываются собственным менеджером транзакционных блокировок. Эти блокировки также могут быть установлены и разработчиком самостоятельно в тех местах кода, где требуется обеспечить неизменность считываемых в транзакции данных (разделяемая блокировка) или запретить чтение данных другими транзакциями (исключительная блокировка).

Управляемые блокировки 1С:Предприятия учитывают логическую структуру прикладного решения поэтому позволяют максимально точно блокировать необходимые области данных (в отличие от использовавшихся ранее блокировок СУБД, которым не известна логическая структура системы). Таким образом менеджер управляемых блокировок позовляет максимально избежать возникновения «плохих» (избыточных) блокировок, блокируюя только действительно необходимые области данных.

В результате любой запрос к данным прежде всего обрабатывается собственным менеджером транзакционных блокировок 1С:Предприятия 8.1 (см. рис. 16). Сюда войдут как управляемые блокировки, автоматически установленные платформой при вызове методов, изменяющих данные, так и блокировки, прописанные программистом в явном виде в коде конфигурации. 
Если на уровне 1С:Предприятия 8.1 конфликт управляемых блокировок не обнаруживается, то запрос передается далее, на исполнение СУБД. СУБД также использует собственный механизм блокировок для определения конфликтующих транзакций, но уже с более низким уровнем изоляции транзакций, чем в режиме автоматических блокировок. 


-----------------

Просмотр блокировок в кластере  
https://its.1c.ru/db/v8320doc#bookmark:cs:TI000000179  

Существуют следующие виды блокировок:

● Блокировки информационной базы:
● БД ‑ блокировка базы данных «1С:Предприятия». Параметры:
    источник блокировки (сеанс или соединение);
    имя информационной базы;
    разделяемая или исключительная;
    если информационная база является разделенной (подробнее см. здесь), то в данном параметре будет указана информация о параметрах заблокированной области в формате параметра /Z командной строки запуска клиентского приложения (подробнее см. здесь). В том случае, если фоновое задание «отнимает» монопольную блокировку у родительского сеанса, то в данном параметре указывается номер родительского сеанса в формате >>НомерСеанса, а параметры заблокированной области указываются следующим параметром.

● ИБ ‑ блокировка информационной базы. Параметры:
    источник блокировки (сеанс или соединение);
    имя информационной базы;
    разделяемая или исключительная.

● Конфигуратор ‑ исключительная блокировка конфигуратора. Параметры:
    имя информационной базы.

● Объект БД ‑ исключительная блокировка объекта «1С:Предприятия».  
    Параметры:
    имя информационной базы.

● Блокировки кластера:

    Менеджер кластера ‑ активность процесса менеджера кластера. 
        Параметры:
            имя сервера;
            порты процесса менеджера кластера.

    Рабочий процесс ‑ активность рабочего процесса «1С:Предприятия». 
        Параметры:
            имя сервера;
            порты рабочего процесса кластера.
    Соединение ‑ соединение с рабочим процессом кластера по TCP или регламентное задание. 
        Параметры:
            имя серверного контекста (может совпадать с именем информационной базы);
            имя компьютера и идентификатор приложения, с которого установлено соединение;
            имена информационной базы и номера соединений, если соединение ассоциировано с одной или несколькими информационными базами.

end
