
// Как воспроизвести ошибку.
//	https://its.1c.ru/db/metod8dev#content:2313:hdoc
// Поставить точки останова на строках
//		новыйЭл = Справочники.Контрагенты.НайтиПоНаименованию("Банан").ПолучитьОбъект();
//		сообщить(т);
// Во втором сеансе запустить код
//		НачатьТранзакцию();
//		Справочники.Контрагенты.НайтиПоНаименованию("Банан").получитьобъект().заблокировать();
//		СУУ_УниверсальныеСервер.Пауза(29);
//		ОтменитьТранзакцию();
//
// Пока блокировка во втором сеансе будет держаться, здесь мы через 20 сек получим ошибку:
//		Конфликт блокировок при выполнении транзакции:
//		Превышено максимальное время ожидания предоставления блокировки
// 
// После отмены транзакции во втором сеансе мы получим искомую ошибку в методе сообщить(т)
//		Ошибка при вызове метода контекста (НайтиПоНаименованию): 
//		В данной транзакции уже происходили ошибки!
//
Процедура ВДаннойТранзакцииУжеБылиОшибки() Экспорт
	
	НачатьТранзакцию();
	
	Записано = Ложь;
	Пока не записано Цикл
		
		Попытка
			
			новыйЭл = Справочники.Контрагенты.НайтиПоНаименованию("Банан").ПолучитьОбъект();
			новыйЭл.ОбменДанными.Загрузка = истина;
			новыйЭл.Записать();
			
			Записано = истина;
			
		Исключение
			//Если ТранзакцияАктивна() Тогда
			//	ОтменитьТранзакцию();
			//КонецЕсли; 
			т=ОписаниеОшибки();
		    сообщить(т);
			ЗаписьЖурналаРегистрации("тест",УровеньЖурналаРегистрации.Ошибка,,,т);
		КонецПопытки;
		
		
	КонецЦикла; 
	
	ЗафиксироватьТранзакцию();
	
	н = Справочники.Контрагенты.НайтиПоНаименованию("вложенная транзакция");
	сообщить("новый контрагент: "+строка(н));
	
	//СУУ_УниверсальныеСервер.Пауза(9);
		
КонецПроцедуры

// Здесь код для второго сеанса нужен такой:
// https://its.1c.ru/db/metod8dev#content:2313:hdoc
	//НачатьТранзакцию();
	//н = Справочники.Контрагенты.НайтиПоНаименованию("Банан");
	//Блокировка = Новый БлокировкаДанных;
	//				
	//ЭлементБлокировки = Блокировка.Добавить();
	//ЭлементБлокировки.Область = "Справочник.Контрагенты";
	//ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
	//ЭлементБлокировки.УстановитьЗначение("Ссылка", н);
	//Блокировка.Заблокировать();
	//
	//СУУ_УниверсальныеСервер.Пауза(49);
	//ОтменитьТранзакцию();
// И нужно дождаться двух ошибок в попытке-исключении!!!
// Ошибка будет одинаковая: Превышено максимальное время ожидания предоставления блокировки
// Исследуемой ошибки уже не будет
Процедура ВДаннойТранзакцииУжеБылиОшибки_Исправление() Экспорт
	
	Записано = Ложь;
	Пока не записано Цикл
		НачатьТранзакцию();
		Попытка
			
			новыйЭл = Справочники.Контрагенты.НайтиПоНаименованию("Банан").ПолучитьОбъект();
			новыйЭл.ОбменДанными.Загрузка = истина;
			новыйЭл.Записать();
			
			ЗафиксироватьТранзакцию();
			
			Записано = истина;
			
		Исключение
			Если ТранзакцияАктивна() Тогда
				ОтменитьТранзакцию();
			КонецЕсли; 
			т=ОписаниеОшибки();
		    сообщить(т);
			ЗаписьЖурналаРегистрации("тест",УровеньЖурналаРегистрации.Ошибка,,,т);
		КонецПопытки;
		
	КонецЦикла; 
	
	
	
	
	//СУУ_УниверсальныеСервер.Пауза(9);
		
КонецПроцедуры
